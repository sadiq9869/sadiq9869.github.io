const SARAPI_KEY = "cac6db70d52a5bcc2fb2c75eca095557ec5fa1500c6e67a3230cba388e9d5a45";  // SerpAPI key
const SARAPI_URL = "https://serpapi.com/search";  // SerpAPI search URL

// Add a message to the chat window
function addMessage(content, sender) {
  const messageDiv = document.createElement("div");
  messageDiv.classList.add("message", sender === "user" ? "userMessage" : "aiMessage");
  messageDiv.textContent = content;
  document.getElementById("responseBox").appendChild(messageDiv);
  document.getElementById("responseBox").scrollTop = document.getElementById("responseBox").scrollHeight;
}

// Function to fetch data from SerpAPI
async function fetchSerpApiData(query) {
  const url = `${SARAPI_URL}?q=${encodeURIComponent(query)}&api_key=${SARAPI_KEY}&engine=google&num=10&start=0&gl=us&hl=en&tbm=nws`;
  
  try {
    const response = await fetch(url);
    const data = await response.json();

    // Check if SerpAPI returns an error
    if (data.error) {
      throw new Error('SerpAPI error: ' + data.error);
    }

    // Check if there are no results in the response
    if (!data.organic_results || data.organic_results.length === 0) {
      throw new Error('No results found for this query.');
    }

    return data;  // Return data for further processing
  } catch (error) {
    console.error("Error fetching data from SerpAPI:", error);
    addMessage(`Error: ${error.message}. Please check your query or try again later.`, "ai");
    return null;
  }
}

// Handle the user's query
async function handleUserQuery(query) {
  addMessage(query, "user");

  const aiMsg = "Supreme AI is searching...";  // Loading message
  addMessage(aiMsg, "ai");

  // Fetch SerpAPI data
  const results = await fetchSerpApiData(query);

  // Remove loading message and display results
  if (results) {
    const responseBox = document.getElementById("responseBox");
    responseBox.lastChild.textContent = "Here are the search results: ";  // Change the loading message

    results.organic_results.forEach((result) => {
      const resultElem = document.createElement("div");
      resultElem.innerHTML = `
        <h3><a href="${result.link}" target="_blank">${result.title}</a></h3>
        <p>${result.snippet}</p>
      `;
      responseBox.appendChild(resultElem);
    });
  } else {
    // Display fallback error message if no results are found
    addMessage("Sorry, I couldn't fetch any results. Please try again later.", "ai");
  }
}

// Handle input when the user presses "Enter"
document.getElementById("userInput").addEventListener("keydown", function(event) {
  if (event.key === "Enter") {
    const userInput = document.getElementById("userInput").value;
    if (userInput.trim() !== "") {
      document.getElementById("userInput").value = "";  // Clear input field
      handleUserQuery(userInput);
    }
  }
});
